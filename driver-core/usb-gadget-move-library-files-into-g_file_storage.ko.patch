From foo@baz Tue Apr  9 12:12:43 2002
Date: Mon, 18 Aug 2008 16:17:23 -0700
To: Greg KH <greg@kroah.com>
From: Greg Kroah-Hartman <gregkh@suse.de>
Subject: USB: gadget: move library files into g_file_storage.ko

This resolves the issues of trying to build a library file with the
current Kbuild infrastructure.

Cc: David Brownell <david-b@pacbell.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/gadget/Makefile       |    3 +--
 drivers/usb/gadget/file_storage.c |   10 ++++++++++
 2 files changed, 11 insertions(+), 2 deletions(-)

--- a/drivers/usb/gadget/file_storage.c
+++ b/drivers/usb/gadget/file_storage.c
@@ -244,6 +244,16 @@
 
 #include "gadget_chips.h"
 
+/*
+ * Kbuild is not very cooperative with respect to linking separately
+ * compiled library objects into one module.  So for now we won't use
+ * separate compilation ... ensuring init/exit sections work to shrink
+ * the runtime footprint, and giving us at least some parts of what
+ * a "gcc --combine ... part1.c part2.c part3.c ... " build would.
+ */
+#include "usbstring.c"
+#include "config.c"
+#include "epautoconf.c"
 
 /*-------------------------------------------------------------------------*/
 
--- a/drivers/usb/gadget/Makefile
+++ b/drivers/usb/gadget/Makefile
@@ -29,8 +29,7 @@ g_ether-objs			:= ether.o
 g_serial-objs			:= serial.o
 g_midi-objs			:= gmidi.o
 gadgetfs-objs			:= inode.o
-g_file_storage-objs		:= file_storage.o usbstring.o config.o \
-					epautoconf.o
+g_file_storage-objs		:= file_storage.o
 g_printer-objs			:= printer.o usbstring.o config.o \
 					epautoconf.o
 g_cdc-objs			:= cdc2.o u_ether.o f_ecm.o \
