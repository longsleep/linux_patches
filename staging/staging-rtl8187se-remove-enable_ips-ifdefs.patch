From bzolnier@gmail.com  Thu Jul 16 16:22:45 2009
From: Bartlomiej Zolnierkiewicz <bzolnier@gmail.com>
Date: Mon, 13 Jul 2009 20:01:38 +0200
Subject: Staging: rtl8187se: remove ENABLE_IPS ifdefs
To: "Greg Kroah-Hartman" <gregkh@suse.de>
Cc: Bartlomiej Zolnierkiewicz <bzolnier@gmail.com>, linux-kernel@vger.kernel.org
Message-ID: <20090713180138.15985.3351.sendpatchset@localhost.localdomain>


From: Bartlomiej Zolnierkiewicz <bzolnier@gmail.com>

Signed-off-by: Bartlomiej Zolnierkiewicz <bzolnier@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 drivers/staging/rtl8187se/Makefile                      |    2 
 drivers/staging/rtl8187se/TODO                          |    1 
 drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c |   38 ----------------
 drivers/staging/rtl8187se/r8180_core.c                  |    4 -
 drivers/staging/rtl8187se/r8180_wx.c                    |    6 --
 drivers/staging/rtl8187se/r8185b_init.c                 |    2 
 6 files changed, 53 deletions(-)

--- a/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c
+++ b/drivers/staging/rtl8187se/ieee80211/ieee80211_softmac.c
@@ -574,7 +574,6 @@ out:
 		DOT11D_ScanComplete(ieee);
 }
 
-#ifdef ENABLE_IPS
 void ieee80211_softmac_scan_wq(struct work_struct *work)
 {
 	struct delayed_work *dwork = to_delayed_work(work);
@@ -617,43 +616,6 @@ out:
 		DOT11D_ScanComplete(ieee);
 	return;
 }
-#else
-void ieee80211_softmac_scan_wq(struct work_struct *work)
-{
-	struct delayed_work *dwork = to_delayed_work(work);
-        struct ieee80211_device *ieee = container_of(work, struct ieee80211_device, softmac_scan_wq);
-        short watchdog = 0;
-	u8 channel_map[MAX_CHANNEL_NUMBER+1];
-	memcpy(channel_map, GET_DOT11D_INFO(ieee)->channel_map, MAX_CHANNEL_NUMBER+1);
-//      printk("enter scan wq,watchdog is %d\n",watchdog);
-        down(&ieee->scan_sem);
-
-        do{
-                ieee->current_network.channel =
-                        (ieee->current_network.channel + 1) % MAX_CHANNEL_NUMBER;
-                if (watchdog++ > MAX_CHANNEL_NUMBER)
-                                goto out; /* no good chans */
-
-        }while(!channel_map[ieee->current_network.channel]);
-
-//      printk("current_network.channel:%d\n", ieee->current_network.channel);
-        if (ieee->scanning == 0 )
-        {
-                printk("error out, scanning = 0\n");
-                goto out;
-        }
-        ieee->set_chan(ieee->dev, ieee->current_network.channel);
-	if(channel_map[ieee->current_network.channel] == 1)
-		ieee80211_send_probe_requests(ieee);
-
-	queue_delayed_work(ieee->wq, &ieee->softmac_scan_wq, IEEE80211_SOFTMAC_SCAN_TIME);
-out:
-	up(&ieee->scan_sem);
-	if(IS_DOT11D_ENABLE(ieee))
-		DOT11D_ScanComplete(ieee);
-}
-
-#endif
 
 void ieee80211_beacons_start(struct ieee80211_device *ieee)
 {
--- a/drivers/staging/rtl8187se/Makefile
+++ b/drivers/staging/rtl8187se/Makefile
@@ -4,8 +4,6 @@
 #EXTRA_CFLAGS += -O2
 #CC            = gcc
 
-#added for EeePC testing
-EXTRA_CFLAGS += -DENABLE_IPS
 EXTRA_CFLAGS += -DSW_ANTE
 EXTRA_CFLAGS += -DTX_TRACK
 EXTRA_CFLAGS += -DHIGH_POWER
--- a/drivers/staging/rtl8187se/r8180_core.c
+++ b/drivers/staging/rtl8187se/r8180_core.c
@@ -3598,13 +3598,11 @@ void rtl8180_watch_dog(struct net_device
 	u32 TotalRxNum = 0;
 	u16 SlotIndex = 0;
 	u16 i = 0;
-#ifdef ENABLE_IPS
 	if(priv->ieee80211->actscanning == false){
 		if((priv->ieee80211->iw_mode != IW_MODE_ADHOC) && (priv->ieee80211->state == IEEE80211_NOLINK) && (priv->ieee80211->beinretry == false) && (priv->eRFPowerState == eRfOn)){
 			IPSEnter(dev);
 		}
 	}
-#endif
 	//YJ,add,080828,for link state check
 	if((priv->ieee80211->state == IEEE80211_LINKED) && (priv->ieee80211->iw_mode == IW_MODE_INFRA)){
 		SlotIndex = (priv->link_detect.SlotIndex++) % priv->link_detect.SlotNum;
@@ -3667,12 +3665,10 @@ int _rtl8180_up(struct net_device *dev)
 	rtl8185b_adapter_start(dev);
 	rtl8185b_rx_enable(dev);
 	rtl8185b_tx_enable(dev);
-#ifdef ENABLE_IPS
 	if(priv->bInactivePs){
 		if(priv->ieee80211->iw_mode == IW_MODE_ADHOC)
 			IPSLeave(dev);
 	}
-#endif
 #ifdef RATE_ADAPT
        timer_rate_adaptive((unsigned long)dev);
 #endif
--- a/drivers/staging/rtl8187se/r8180_wx.c
+++ b/drivers/staging/rtl8187se/r8180_wx.c
@@ -194,13 +194,11 @@ static int r8180_wx_set_mode(struct net_
 		return 0;
 
 	down(&priv->wx_sem);
-#ifdef ENABLE_IPS
 //	printk("set mode ENABLE_IPS\n");
 	if(priv->bInactivePs){
 		if(wrqu->mode == IW_MODE_ADHOC)
 			IPSLeave(dev);
 	}
-#endif
 	ret = ieee80211_wx_set_mode(priv->ieee80211,a,wrqu,b);
 
 	//rtl8180_commit(dev);
@@ -363,7 +361,6 @@ static int r8180_wx_set_scan(struct net_
 
 	down(&priv->wx_sem);
 	if(priv->up){
-#ifdef ENABLE_IPS
 //		printk("set scan ENABLE_IPS\n");
 		priv->ieee80211->actscanning = true;
 		if(priv->bInactivePs && (priv->ieee80211->state != IEEE80211_LINKED)){
@@ -386,7 +383,6 @@ static int r8180_wx_set_scan(struct net_
 			ret = 0;
 		}
 		else
-#endif
 		{
 			//YJ,add,080828, prevent scan in BusyTraffic
 			//FIXME: Need to consider last scan time
@@ -439,11 +435,9 @@ static int r8180_wx_set_essid(struct net
 		return 0;
 
 	down(&priv->wx_sem);
-#ifdef ENABLE_IPS
 	//printk("set essid ENABLE_IPS\n");
 	if(priv->bInactivePs)
 		IPSLeave(dev);
-#endif
 //	printk("haha:set essid %s essid_len = %d essid_flgs = %d\n",b,  wrqu->essid.length, wrqu->essid.flags);
 
 	ret = ieee80211_wx_set_essid(priv->ieee80211,a,wrqu,b);
--- a/drivers/staging/rtl8187se/r8185b_init.c
+++ b/drivers/staging/rtl8187se/r8185b_init.c
@@ -2546,7 +2546,6 @@ void rtl8185b_adapter_start(struct net_d
 		InitWirelessMode = ieee->mode;
 	}
 //by amy for power save
-#ifdef ENABLE_IPS
 //	printk("initialize ENABLE_IPS\n");
 	priv->eRFPowerState = eRfOff;
 	priv->RfOffReason = 0;
@@ -2571,7 +2570,6 @@ void rtl8185b_adapter_start(struct net_d
 	//	printk("rf off cost jiffies:%lx\n", (tmp2-tmp)*1000/HZ);
 
 	}
-#endif
 //	IPSEnter(dev);
 //by amy for power save
 #ifdef TODO
--- a/drivers/staging/rtl8187se/TODO
+++ b/drivers/staging/rtl8187se/TODO
@@ -1,6 +1,5 @@
 TODO:
 - prepare private ieee80211 stack for merge with rtl8192su's version:
-  - remove ENABLE_IPS ifdefs
   - rename struct ieee80211_hdr to struct ieee80211_hdr_4addr
   - rename struct ieee80211_hdr_3addr_QOS to struct ieee80211_hdr_3addrqos
   - rename struct ieee80211_hdr_QOS to struct ieee80211_hdr_4addrqos
