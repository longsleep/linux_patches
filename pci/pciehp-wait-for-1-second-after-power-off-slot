From kristen.c.accardi@intel.com Thu May 31 09:43:55 2007
From: Kenji Kaneshige <kaneshige.kenji@jp.fujitsu.com>
Date: Thu, 31 May 2007 09:43:35 -0700
Subject: PCI: hotplug: pciehp: wait for 1 second after power off slot
To: gregkh@suse.de
Cc: Kenji Kaneshige <kaneshige.kenji@jp.fujitsu.com>, Kristen Carlson Accardi <kristen.c.accardi@intel.com>
Message-ID: <20070531164354.971188430@intel.com>
Content-Disposition: inline; filename=pciehp-wait-for-1-second-after-power-off-slot


From: Kenji Kaneshige <kaneshige.kenji@jp.fujitsu.com>

According to the specification, we must wait for at least 1 second
after turning power off before taking any action that relies on power
having been removed from the slot/adapter.

Signed-off-by: Kenji Kaneshige <kaneshige.kenji@jp.fujitsu.com>
Signed-off-by: Kristen Carlson Accardi <kristen.c.accardi@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/pci/hotplug/pciehp_ctrl.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/drivers/pci/hotplug/pciehp_ctrl.c
+++ b/drivers/pci/hotplug/pciehp_ctrl.c
@@ -186,6 +186,12 @@ static void set_slot_off(struct controll
 			    __FUNCTION__);
 			return;
 		}
+		/*
+		 * After turning power off, we must wait for at least
+		 * 1 second before taking any action that relies on
+		 * power having been removed from the slot/adapter.
+		 */
+		msleep(1000);
 	}
 
 	if (PWR_LED(ctrl->ctrlcap))
@@ -298,6 +304,12 @@ static int remove_board(struct slot *p_s
 			    __FUNCTION__);
 			return retval;
 		}
+		/*
+		 * After turning power off, we must wait for at least
+		 * 1 second before taking any action that relies on
+		 * power having been removed from the slot/adapter.
+		 */
+		msleep(1000);
 	}
 
 	if (PWR_LED(ctrl->ctrlcap))
