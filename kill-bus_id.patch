From kay.sievers@vrfy.org Wed May 28 15:24:18 2008
From: Kay Sievers <kay.sievers@vrfy.org>
Subject: driver core: remove bus_id[20] string from struct device
Date: Wed, 28 May 2008 22:51:03 +0200
Message-Id: <1212007863.2482.5.camel@linux.site>

All device names are dynamically allocated now and are set and
read from the kobject, instead of keeping a 20 char long copy
of the string in every struct device.

Signed-off-by: Kay Sievers <kay.sievers@vrfy.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/base/core.c    |   12 ++----------
 include/linux/device.h |    6 +-----
 2 files changed, 3 insertions(+), 15 deletions(-)

--- a/drivers/base/core.c
+++ b/drivers/base/core.c
@@ -896,10 +896,6 @@ int device_add(struct device *dev)
 		goto Done;
 	}
 
-	/* support bus_id until everything is converted, and it is removed */
-	if (!dev->init_name)
-		dev->init_name = dev->bus_id;
-
 	if (strlen(dev->init_name) == 0) {
 		printk(KERN_ERR "device (%p) does not have a name\n", dev);
 		error = -EINVAL;
@@ -1395,19 +1391,15 @@ int device_rename(struct device *dev, ch
 		old_class_name = make_class_name(dev->class->name, &dev->kobj);
 #endif
 
-	old_device_name = kmalloc(BUS_ID_SIZE, GFP_KERNEL);
+	old_device_name = kstrdup(dev_name(dev), GFP_KERNEL);
 	if (!old_device_name) {
 		error = -ENOMEM;
 		goto out;
 	}
-	strlcpy(old_device_name, dev_name(dev), BUS_ID_SIZE);
-	strlcpy(dev->bus_id, new_name, BUS_ID_SIZE);
 
 	error = kobject_rename(&dev->kobj, new_name);
-	if (error) {
-		strlcpy(dev->bus_id, old_device_name, BUS_ID_SIZE);
+	if (error)
 		goto out;
-	}
 
 #ifdef CONFIG_SYSFS_DEPRECATED
 	if (old_class_name) {
--- a/include/linux/device.h
+++ b/include/linux/device.h
@@ -349,7 +349,6 @@ struct device {
 	struct device		*parent;
 
 	struct kobject kobj;
-	char	bus_id[20];	/* will be removed */
 	struct device_type	*type;
 	const char		*init_name;
 	unsigned int		init_name_is_set:1;
@@ -405,10 +404,7 @@ static inline const char *dev_name(struc
 	/* return sensible value between dev_set_name() and device_add() */
 	if (dev->init_name)
 		return dev->init_name;
-	/* support bus_id until everything is converted, and it is removed */
-	if (kobject_name(&dev->kobj))
-		return kobject_name(&dev->kobj);
-	return dev->bus_id;
+	return kobject_name(&dev->kobj);
 }
 
 extern int dev_set_name(struct device *dev, const char *name, ...)
