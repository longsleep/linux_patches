From sarah.a.sharp@linux.intel.com  Thu Nov  5 10:18:01 2009
From: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Date: Wed, 4 Nov 2009 11:22:19 -0800
Subject: USB: xhci: Fix scratchpad deallocation.
To: Greg KH <gregkh@suse.de>
Cc: John Youn <John.Youn@synopsys.com>, linux-usb@vger.kernel.org
Message-ID: <20091104192219.GA5081@xanatos>
Content-Disposition: inline


The scratchpad_free() function uses xhci->page_size to free some memory
with pci_free_consistent().  However, the page_size is set to zero before
the call, causing kernel oopses on driver unload.  Call scratchpad_free()
before setting xhci->page_size to zero.

Signed-off-by: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Acked-by: John Youn <John.Youn@synopsys.com>
Cc: stable <stable@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/host/xhci-mem.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/usb/host/xhci-mem.c
+++ b/drivers/usb/host/xhci-mem.c
@@ -843,9 +843,9 @@ void xhci_mem_cleanup(struct xhci_hcd *x
 				xhci->dcbaa, xhci->dcbaa->dma);
 	xhci->dcbaa = NULL;
 
+	scratchpad_free(xhci);
 	xhci->page_size = 0;
 	xhci->page_shift = 0;
-	scratchpad_free(xhci);
 }
 
 int xhci_mem_init(struct xhci_hcd *xhci, gfp_t flags)
