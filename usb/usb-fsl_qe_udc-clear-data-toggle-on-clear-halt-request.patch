From leoli@freescale.com  Wed Oct  1 14:00:33 2008
From: Li Yang <leoli@freescale.com>
Date: Wed, 24 Sep 2008 15:50:27 +0800
Subject: usb/fsl_qe_udc: clear data toggle on clear halt request
To: gregkh@suse.de
Cc: david-b@pacbell.net, linux-usb@vger.kernel.org, Li Yang <leoli@freescale.com>
Message-ID: <1222242627-24730-2-git-send-email-leoli@freescale.com>


Fix to comply with USB spec.

Signed-off-by: Li Yang <leoli@freescale.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/gadget/fsl_qe_udc.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/usb/gadget/fsl_qe_udc.c
+++ b/drivers/usb/gadget/fsl_qe_udc.c
@@ -1815,6 +1815,10 @@ static int qe_ep_set_halt(struct usb_ep 
 		udc->ep0_state = WAIT_FOR_SETUP;
 		udc->ep0_dir = 0;
 	}
+
+	/* set data toggle to DATA0 on clear halt */
+	if (value == 0)
+		ep->data01 = 0;
 out:
 	dev_vdbg(udc->dev, "%s %s halt stat %d\n", ep->ep.name,
 			value ?  "set" : "clear", status);
