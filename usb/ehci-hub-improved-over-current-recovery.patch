From david-b@pacbell.net Wed May 30 11:04:51 2007
From: Christian Engelmayer <christian.engelmayer@frequentis.com>
To: Greg KH <greg@kroah.com>
Subject: ehci-hub: improved over-current recovery
Date: Wed, 30 May 2007 11:04:48 -0700
Cc: Engelmayer Christian <Christian.Engelmayer@frequentis.com>
Content-Disposition: inline
Message-Id: <200705301104.49029.david-b@pacbell.net>

From: Christian Engelmayer <christian.engelmayer@frequentis.com>

According to the USB Specification Revision 2.0 chapter 11.12.5
a hub experiencing an over-current condition must place all
affected ports in the powered-off state. It seems that some root
hubs need port power to be cycled by software in order to get back
to normal functionality after an over-current condition ... like
the EHCI implementation on an MPC8343E.

Signed-off-by: Christian Engelmayer <christian.engelmayer@frequentis.com>
Signed-off-by: David Brownell <david-b@pacbell.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/host/ehci-hub.c |   16 ++++++++++++++++
 1 file changed, 16 insertions(+)

--- a/drivers/usb/host/ehci-hub.c
+++ b/drivers/usb/host/ehci-hub.c
@@ -483,6 +483,22 @@ ehci_hub_status_data (struct usb_hcd *hc
 			    buf [1] |= 1 << (i - 7);
 			status = STS_PCD;
 		}
+
+		/*
+		 * Hubs should disable port power on over-current. However,
+		 * not all EHCI implementations do this automatically, even
+		 * if they _do_ support per-port power switching; they're
+		 * allowed to just limit the current.  khubd will turn the
+		 * power back on.
+		 */
+		if (temp & PORT_OCC) {
+			if (HCS_PPC(ehci->hcs_params)) {
+				temp &= ~(PORT_RWC_BITS | PORT_POWER);
+				ehci_writel(ehci, temp,
+					&ehci->regs->port_status[i]);
+			}
+		}
+
 	}
 	/* FIXME autosuspend idle root hubs */
 	spin_unlock_irqrestore (&ehci->lock, flags);
