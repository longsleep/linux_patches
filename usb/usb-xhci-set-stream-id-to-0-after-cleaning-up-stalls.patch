From sarah.a.sharp@linux.intel.com  Tue May 11 16:25:21 2010
From: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Date: Thu, 6 May 2010 13:40:18 -0700
Subject: USB: xhci: Set stream ID to 0 after cleaning up stalls.
To: Greg KH <gregkh@suse.de>
Cc: linux-usb@vger.kernel.org
Message-ID: <20100506204018.GA30446@xanatos>
Content-Disposition: inline


After using state stored in xhci_virt_ep to clean up a stalled endpoint,
be sure to set the stalled stream ID back to 0.

Signed-off-by: Sarah Sharp <sarah.a.sharp@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/host/xhci-ring.c |    1 +
 drivers/usb/host/xhci.c      |    1 +
 2 files changed, 2 insertions(+)

--- a/drivers/usb/host/xhci-ring.c
+++ b/drivers/usb/host/xhci-ring.c
@@ -1166,6 +1166,7 @@ static void xhci_cleanup_halted_endpoint
 
 	ep->stopped_td = NULL;
 	ep->stopped_trb = NULL;
+	ep->stopped_stream = 0;
 
 	xhci_ring_cmd_db(xhci);
 }
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@ -1457,6 +1457,7 @@ void xhci_endpoint_reset(struct usb_hcd
 	}
 	virt_ep->stopped_td = NULL;
 	virt_ep->stopped_trb = NULL;
+	virt_ep->stopped_stream = 0;
 	spin_unlock_irqrestore(&xhci->lock, flags);
 
 	if (ret)
