From peter.korsgaard@barco.com  Thu Apr 29 16:25:42 2010
From: Peter Korsgaard <peter.korsgaard@barco.com>
Date: Mon, 26 Apr 2010 10:05:06 +0200
Subject: USB: g_hid: unregister platform driver on probe/usb_composite_register errors
To: gregkh@suse.de, linux-usb@vger.kernel.org
Cc: fabien.chouteau@barco.com, Peter Korsgaard <peter.korsgaard@barco.com>
Message-ID: <1272269106-24027-1-git-send-email-peter.korsgaard@barco.com>


Otherwise reloads will fail.

Signed-off-by: Peter Korsgaard <peter.korsgaard@barco.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/gadget/hid.c |   14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

--- a/drivers/usb/gadget/hid.c
+++ b/drivers/usb/gadget/hid.c
@@ -275,8 +275,18 @@ MODULE_LICENSE("GPL");
 
 static int __init hidg_init(void)
 {
-	platform_driver_probe(&hidg_plat_driver, hidg_plat_driver_probe);
-	return usb_composite_register(&hidg_driver);
+	int status;
+
+	status = platform_driver_probe(&hidg_plat_driver,
+				hidg_plat_driver_probe);
+	if (status < 0)
+		return status;
+
+	status = usb_composite_register(&hidg_driver);
+	if (status < 0)
+		platform_driver_unregister(&hidg_plat_driver);
+
+	return status;
 }
 module_init(hidg_init);
 
