From alan@linux.intel.com  Tue Oct 27 10:08:01 2009
From: Alan Cox <alan@linux.intel.com>
Date: Tue, 06 Oct 2009 16:06:57 +0100
Subject: [PATCH 5/5] opticon: Fix resume logic
To: greg@kroah.com, linux-kernel@vger.kernel.org, linux-usb@vger.kernel.org
Message-ID: <20091006150651.9431.16939.stgit@localhost.localdomain>


Opticon now takes the right mutex to check the port status but the status
check is done wrongly for the modern serial code, so fix it.

Signed-off-by: Alan Cox <alan@linux.intel.com>
Cc: Alan Stern <stern@rowland.harvard.edu>
Cc: Oliver Neukum <oliver@neukum.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/usb/serial/opticon.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/usb/serial/opticon.c
+++ b/drivers/usb/serial/opticon.c
@@ -502,7 +502,8 @@ static int opticon_resume(struct usb_int
 	int result;
 
 	mutex_lock(&port->port.mutex);
-	if (port->port.count)
+	/* This is protected by the port mutex against close/open */
+	if (test_bit(ASYNCB_INITIALIZED, &port->port.flags))
 		result = usb_submit_urb(priv->bulk_read_urb, GFP_NOIO);
 	else
 		result = 0;
