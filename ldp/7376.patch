From foo@baz Tue Apr  9 12:12:43 2002
Date: Wed, 09 Apr 2008 07:41:21 +0400
From: Manu Abraham <manu@linuxtv.org>
To: Greg KH <greg@kroah.com>
Subject:

Reorganization move frontend specific stuff to firesat_fe.c

Cc: Christian Dolzer <c.dolzer@digital-everywhere.com>
Cc: Andreas Monitzer <andy@monitzer.com>
Cc: Fabio De Lorenzo <delorenzo.fabio@gmail.com>
Cc: Robert Berger <robert.berger@reliableembeddedsystems.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 drivers/media/dvb/firesat/firesat.h      |    8 
 drivers/media/dvb/firesat/firesat_1394.c |  216 -------------------------
 drivers/media/dvb/firesat/firesat_dvb.c  |   18 +-
 drivers/media/dvb/firesat/firesat_fe.c   |  263 +++++++++++++++++++++++++++++++
 4 files changed, 288 insertions(+), 217 deletions(-)

--- a/drivers/media/dvb/firesat/firesat.h
+++ b/drivers/media/dvb/firesat/firesat.h
@@ -27,6 +27,7 @@ struct firesat {
 	struct dmx_frontend		frontend;
 	struct dvb_net			dvbnet;
 	struct dvb_frontend_info	*frontend_info;
+	struct dvb_frontend		*fe;
 
 	struct dvb_device		*cadev;
 	int				has_ci;
@@ -73,7 +74,12 @@ extern spinlock_t firesat_list_lock;
 /* firesat_dvb.c */
 extern int firesat_start_feed(struct dvb_demux_feed *dvbdmxfeed);
 extern int firesat_stop_feed(struct dvb_demux_feed *dvbdmxfeed);
-extern int firesat_dvbdev_init(struct firesat *firesat);
+extern int firesat_dvbdev_init(struct firesat *firesat,
+				struct device *dev,
+				struct dvb_frontend *fe);
+
+/* firesat_fe.c */
+extern int firesat_frontend_attach(struct firesat *firesat, struct dvb_frontend *fe);
 
 
 #endif
--- a/drivers/media/dvb/firesat/firesat_1394.c
+++ b/drivers/media/dvb/firesat/firesat_1394.c
@@ -99,6 +99,7 @@ static struct hpsb_highlevel firesat_hig
 	.fcp_request	= fcp_request,
 };
 
+#if 0
 static int firesat_dvb_init(struct dvb_frontend *fe);
 static int firesat_sleep(struct dvb_frontend *fe);
 
@@ -121,83 +122,7 @@ static int firesat_set_frontend(struct d
 				struct dvb_frontend_parameters *params);
 static int firesat_get_frontend(struct dvb_frontend *fe,
 				struct dvb_frontend_parameters *params);
-
-static struct dvb_frontend_ops firesat_ops = {
-
-	.init				= firesat_dvb_init,
-	.sleep				= firesat_sleep,
-
-	.set_frontend			= firesat_set_frontend,
-	.get_frontend			= firesat_get_frontend,
-
-	.read_status			= firesat_read_status,
-	.read_ber			= firesat_read_ber,
-	.read_signal_strength		= firesat_read_signal_strength,
-	.read_snr			= firesat_read_snr,
-	.read_ucblocks			= firesat_read_uncorrected_blocks,
-
-	.diseqc_send_master_cmd 	= firesat_diseqc_send_master_cmd,
-	.diseqc_send_burst		= firesat_diseqc_send_burst,
-	.set_tone			= firesat_set_tone,
-	.set_voltage			= firesat_set_voltage,
-};
-
-static struct dvb_frontend_info firesat_S_frontend_info = {
-
-	.name			= "FireSAT DVB-S Frontend",
-	.type			= FE_QPSK,
-
-	.frequency_min		= 950000,
-	.frequency_max		= 2150000,
-	.frequency_stepsize	= 125,
-	.symbol_rate_min	= 1000000,
-	.symbol_rate_max	= 40000000,
-
-	.caps 			= FE_CAN_INVERSION_AUTO		|
-				  FE_CAN_FEC_1_2		|
-				  FE_CAN_FEC_2_3		|
-				  FE_CAN_FEC_3_4		|
-				  FE_CAN_FEC_5_6		|
-				  FE_CAN_FEC_7_8		|
-				  FE_CAN_FEC_AUTO		|
-				  FE_CAN_QPSK,
-};
-
-static struct dvb_frontend_info firesat_C_frontend_info = {
-
-	.name			= "FireSAT DVB-C Frontend",
-	.type			= FE_QAM,
-
-	.frequency_min		= 47000000,
-	.frequency_max		= 866000000,
-	.frequency_stepsize	= 62500,
-	.symbol_rate_min	= 870000,
-	.symbol_rate_max	= 6900000,
-
-	.caps 			= FE_CAN_INVERSION_AUTO 	|
-				  FE_CAN_QAM_16			|
-				  FE_CAN_QAM_32			|
-				  FE_CAN_QAM_64			|
-				  FE_CAN_QAM_128		|
-				  FE_CAN_QAM_256		|
-				  FE_CAN_QAM_AUTO,
-};
-
-static struct dvb_frontend_info firesat_T_frontend_info = {
-
-	.name			= "FireSAT DVB-T Frontend",
-	.type			= FE_OFDM,
-
-	.frequency_min		= 49000000,
-	.frequency_max		= 861000000,
-	.frequency_stepsize	= 62500,
-
-	.caps 			= FE_CAN_INVERSION_AUTO		|
-				  FE_CAN_FEC_2_3		|
-				  FE_CAN_TRANSMISSION_MODE_AUTO |
-				  FE_CAN_GUARD_INTERVAL_AUTO	|
-				  FE_CAN_HIERARCHY_AUTO,
-};
+#endif
 
 static void firesat_add_host (struct hpsb_host *host)
 {
@@ -353,138 +278,6 @@ static void fcp_request(struct hpsb_host
 	} // else ignore
 }
 
-static int firesat_dvb_init(struct dvb_frontend *fe)
-{
-	struct firesat *firesat = fe->sec_priv;
-	printk("fdi: 1\n");
-	firesat->isochannel = firesat->adapter->num; //<< 1 | (firesat->subunit & 0x1); // ### ask IRM
-	printk("fdi: 2\n");
-	try_CMPEstablishPPconnection(firesat, firesat->subunit, firesat->isochannel);
-	printk("fdi: 3\n");
-//FIXME	hpsb_listen_channel(&firesat_highlevel, firesat->host, firesat->isochannel);
-	printk("fdi: 4\n");
-	return 0;
-}
-
-static int firesat_sleep(struct dvb_frontend *fe)
-{
-	struct firesat *firesat = fe->sec_priv;
-
-//FIXME	hpsb_unlisten_channel(&firesat_highlevel, firesat->host, firesat->isochannel);
-	try_CMPBreakPPconnection(firesat, firesat->subunit, firesat->isochannel);
-	firesat->isochannel = -1;
-	return 0;
-}
-
-static int firesat_diseqc_send_master_cmd(struct dvb_frontend *fe,
-					  struct dvb_diseqc_master_cmd *cmd)
-{
-	struct firesat *firesat = fe->sec_priv;
-
-	return AVCLNBControl(firesat, LNBCONTROL_DONTCARE, LNBCONTROL_DONTCARE,
-			     LNBCONTROL_DONTCARE, 1, cmd);
-}
-
-static int firesat_diseqc_send_burst(struct dvb_frontend *fe,
-				     fe_sec_mini_cmd_t minicmd)
-{
-	return 0;
-}
-
-static int firesat_set_tone(struct dvb_frontend *fe, fe_sec_tone_mode_t tone)
-{
-	struct firesat *firesat = fe->sec_priv;
-
-	firesat->tone = tone;
-	return 0;
-}
-
-static int firesat_set_voltage(struct dvb_frontend *fe,
-			       fe_sec_voltage_t voltage)
-{
-	struct firesat *firesat = fe->sec_priv;
-
-	firesat->voltage = voltage;
-	return 0;
-}
-
-static int firesat_read_status (struct dvb_frontend *fe, fe_status_t *status)
-{
-	struct firesat *firesat = fe->sec_priv;
-	ANTENNA_INPUT_INFO info;
-
-	if (AVCTunerStatus(firesat, &info))
-		return -EINVAL;
-
-	if (info.NoRF)
-		*status = 0;
-	else
-		*status = *status = FE_HAS_SIGNAL	|
-				    FE_HAS_VITERBI	|
-				    FE_HAS_SYNC		|
-				    FE_HAS_CARRIER	|
-				    FE_HAS_LOCK;
-
-	return 0;
-}
-
-static int firesat_read_ber (struct dvb_frontend *fe, u32 *ber)
-{
-	struct firesat *firesat = fe->sec_priv;
-	ANTENNA_INPUT_INFO info;
-
-	if (AVCTunerStatus(firesat, &info))
-		return -EINVAL;
-
-	*ber = ((info.BER[0] << 24) & 0xff)	|
-	       ((info.BER[1] << 16) & 0xff)	|
-	       ((info.BER[2] << 8) & 0xff)	|
-		(info.BER[3] & 0xff);
-
-	return 0;
-}
-
-static int firesat_read_signal_strength (struct dvb_frontend *fe, u16 *strength)
-{
-	struct firesat *firesat = fe->sec_priv;
-	ANTENNA_INPUT_INFO info;
-	u16 *signal = strength;
-
-	if (AVCTunerStatus(firesat, &info))
-		return -EINVAL;
-
-	*signal = info.SignalStrength;
-
-	return 0;
-}
-
-static int firesat_read_snr(struct dvb_frontend *fe, u16 *snr)
-{
-	return -EOPNOTSUPP;
-}
-
-static int firesat_read_uncorrected_blocks(struct dvb_frontend *fe, u32 *ucblocks)
-{
-	return -EOPNOTSUPP;
-}
-
-static int firesat_set_frontend(struct dvb_frontend *fe,
-				struct dvb_frontend_parameters *params)
-{
-	struct firesat *firesat = fe->sec_priv;
-
-	if (AVCTuner_DSD(firesat, params, NULL) != ACCEPTED)
-		return -EINVAL;
-	else
-		return 0; //not sure of this...
-}
-
-static int firesat_get_frontend(struct dvb_frontend *fe,
-				struct dvb_frontend_parameters *params)
-{
-	return -EOPNOTSUPP;
-}
-
 static int firesat_probe(struct device *dev)
 {
 	struct unit_directory *ud = container_of(dev, struct unit_directory, device);
@@ -570,7 +363,7 @@ static int firesat_probe(struct device *
 		}
 
 // ----
-		firesat_dvbdev_init(firesat);
+		firesat_dvbdev_init(firesat, dev, fe);
 // ----
 		firesats[subunit] = firesat;
 	} // loop for all tuners
@@ -596,6 +389,7 @@ static int firesat_remove(struct device 
 				if (firesats[k]->has_ci)
 					firesat_ca_release(firesats[k]);
 
+#if 0
 				if (!(fe = kmalloc(sizeof (struct dvb_frontend), GFP_KERNEL))) {
 					fe->ops = firesat_ops;
 					fe->dvb = firesats[k]->adapter;
@@ -603,7 +397,7 @@ static int firesat_remove(struct device 
 					dvb_unregister_frontend(fe);
 					kfree(fe);
 				}
-
+#endif
 				dvb_net_release(&firesats[k]->dvbnet);
 				firesats[k]->demux.dmx.close(&firesats[k]->demux.dmx);
 				firesats[k]->demux.dmx.remove_frontend(&firesats[k]->demux.dmx, &firesats[k]->frontend);
--- a/drivers/media/dvb/firesat/firesat_dvb.c
+++ b/drivers/media/dvb/firesat/firesat_dvb.c
@@ -183,8 +183,12 @@ int firesat_stop_feed(struct dvb_demux_f
 	return 0;
 }
 
-int firesat_dvbdev_init(struct firesat *firesat)
+int firesat_dvbdev_init(struct firesat *firesat,
+			struct device *dev,
+			struct dvb_frontend *fe)
 {
+	int result;
+
 		firesat->has_ci = 1; // TEMP workaround
 
 #if 0
@@ -208,6 +212,7 @@ int firesat_dvbdev_init(struct firesat *
 			firesat->frontend_info = NULL;
 		}
 #endif
+/* // ------- CRAP -----------
 		if (!firesat->frontend_info) {
 			spin_lock_irqsave(&firesat_list_lock, flags);
 			list_del(&firesat->list);
@@ -215,7 +220,7 @@ int firesat_dvbdev_init(struct firesat *
 			kfree(firesat);
 			continue;
 		}
-
+*/
 		//initialising firesat->adapter before calling dvb_register_adapter
 		if (!(firesat->adapter = kmalloc(sizeof (struct dvb_adapter), GFP_KERNEL))) {
 			printk("%s: couldn't allocate memory.\n", __func__);
@@ -230,11 +235,12 @@ int firesat_dvbdev_init(struct firesat *
 						   dev)) < 0) {
 
 			printk("%s: dvb_register_adapter failed: error %d\n", __func__, result);
-
+#if 0
 			/* ### cleanup */
 			spin_lock_irqsave(&firesat_list_lock, flags);
 			list_del(&firesat->list);
 			spin_unlock_irqrestore(&firesat_list_lock, flags);
+#endif
 			kfree(firesat);
 
 			return result;
@@ -301,8 +307,10 @@ int firesat_dvbdev_init(struct firesat *
 
 		dvb_net_init(firesat->adapter, &firesat->dvbnet, &firesat->demux.dmx);
 
-		fe->ops = firesat_ops;
-		fe->dvb = firesat->adapter;
+//		fe->ops = firesat_ops;
+//		fe->dvb = firesat->adapter;
+		firesat_frontend_attach(firesat, fe);
+
 		fe->sec_priv = firesat; //IMPORTANT, functions depend on this!!!
 		if ((result= dvb_register_frontend(firesat->adapter, fe)) < 0) {
 			printk("%s: dvb_register_frontend_new failed: error %d\n", __func__, result);
--- /dev/null
+++ b/drivers/media/dvb/firesat/firesat_fe.c
@@ -0,0 +1,263 @@
+#include <linux/init.h>
+#include <linux/slab.h>
+#include <linux/wait.h>
+#include <linux/module.h>
+#include <linux/delay.h>
+#include <linux/time.h>
+#include <linux/errno.h>
+#include <linux/interrupt.h>
+#include <asm/semaphore.h>
+#include <ieee1394_hotplug.h>
+#include <nodemgr.h>
+#include <highlevel.h>
+#include <ohci1394.h>
+#include <hosts.h>
+#include <dvbdev.h>
+
+#include "firesat.h"
+#include "avc_api.h"
+#include "cmp.h"
+#include "firesat-rc.h"
+#include "firesat-ci.h"
+
+static int firesat_dvb_init(struct dvb_frontend *fe)
+{
+	struct firesat *firesat = fe->sec_priv;
+	printk("fdi: 1\n");
+	firesat->isochannel = firesat->adapter->num; //<< 1 | (firesat->subunit & 0x1); // ### ask IRM
+	printk("fdi: 2\n");
+	try_CMPEstablishPPconnection(firesat, firesat->subunit, firesat->isochannel);
+	printk("fdi: 3\n");
+//FIXME	hpsb_listen_channel(&firesat_highlevel, firesat->host, firesat->isochannel);
+	printk("fdi: 4\n");
+	return 0;
+}
+
+static int firesat_sleep(struct dvb_frontend *fe)
+{
+	struct firesat *firesat = fe->sec_priv;
+
+//FIXME	hpsb_unlisten_channel(&firesat_highlevel, firesat->host, firesat->isochannel);
+	try_CMPBreakPPconnection(firesat, firesat->subunit, firesat->isochannel);
+	firesat->isochannel = -1;
+	return 0;
+}
+
+static int firesat_diseqc_send_master_cmd(struct dvb_frontend *fe,
+					  struct dvb_diseqc_master_cmd *cmd)
+{
+	struct firesat *firesat = fe->sec_priv;
+
+	return AVCLNBControl(firesat, LNBCONTROL_DONTCARE, LNBCONTROL_DONTCARE,
+			     LNBCONTROL_DONTCARE, 1, cmd);
+}
+
+static int firesat_diseqc_send_burst(struct dvb_frontend *fe,
+				     fe_sec_mini_cmd_t minicmd)
+{
+	return 0;
+}
+
+static int firesat_set_tone(struct dvb_frontend *fe, fe_sec_tone_mode_t tone)
+{
+	struct firesat *firesat = fe->sec_priv;
+
+	firesat->tone = tone;
+	return 0;
+}
+
+static int firesat_set_voltage(struct dvb_frontend *fe,
+			       fe_sec_voltage_t voltage)
+{
+	struct firesat *firesat = fe->sec_priv;
+
+	firesat->voltage = voltage;
+	return 0;
+}
+
+static int firesat_read_status (struct dvb_frontend *fe, fe_status_t *status)
+{
+	struct firesat *firesat = fe->sec_priv;
+	ANTENNA_INPUT_INFO info;
+
+	if (AVCTunerStatus(firesat, &info))
+		return -EINVAL;
+
+	if (info.NoRF)
+		*status = 0;
+	else
+		*status = *status = FE_HAS_SIGNAL	|
+				    FE_HAS_VITERBI	|
+				    FE_HAS_SYNC		|
+				    FE_HAS_CARRIER	|
+				    FE_HAS_LOCK;
+
+	return 0;
+}
+
+static int firesat_read_ber (struct dvb_frontend *fe, u32 *ber)
+{
+	struct firesat *firesat = fe->sec_priv;
+	ANTENNA_INPUT_INFO info;
+
+	if (AVCTunerStatus(firesat, &info))
+		return -EINVAL;
+
+	*ber = ((info.BER[0] << 24) & 0xff)	|
+	       ((info.BER[1] << 16) & 0xff)	|
+	       ((info.BER[2] << 8) & 0xff)	|
+		(info.BER[3] & 0xff);
+
+	return 0;
+}
+
+static int firesat_read_signal_strength (struct dvb_frontend *fe, u16 *strength)
+{
+	struct firesat *firesat = fe->sec_priv;
+	ANTENNA_INPUT_INFO info;
+	u16 *signal = strength;
+
+	if (AVCTunerStatus(firesat, &info))
+		return -EINVAL;
+
+	*signal = info.SignalStrength;
+
+	return 0;
+}
+
+static int firesat_read_snr(struct dvb_frontend *fe, u16 *snr)
+{
+	return -EOPNOTSUPP;
+}
+
+static int firesat_read_uncorrected_blocks(struct dvb_frontend *fe, u32 *ucblocks)
+{
+	return -EOPNOTSUPP;
+}
+
+static int firesat_set_frontend(struct dvb_frontend *fe,
+				struct dvb_frontend_parameters *params)
+{
+	struct firesat *firesat = fe->sec_priv;
+
+	if (AVCTuner_DSD(firesat, params, NULL) != ACCEPTED)
+		return -EINVAL;
+	else
+		return 0; //not sure of this...
+}
+
+static int firesat_get_frontend(struct dvb_frontend *fe,
+				struct dvb_frontend_parameters *params)
+{
+	return -EOPNOTSUPP;
+}
+
+static struct dvb_frontend_info firesat_S_frontend_info;
+static struct dvb_frontend_info firesat_C_frontend_info;
+static struct dvb_frontend_info firesat_T_frontend_info;
+
+static struct dvb_frontend_ops firesat_ops = {
+
+	.init				= firesat_dvb_init,
+	.sleep				= firesat_sleep,
+
+	.set_frontend			= firesat_set_frontend,
+	.get_frontend			= firesat_get_frontend,
+
+	.read_status			= firesat_read_status,
+	.read_ber			= firesat_read_ber,
+	.read_signal_strength		= firesat_read_signal_strength,
+	.read_snr			= firesat_read_snr,
+	.read_ucblocks			= firesat_read_uncorrected_blocks,
+
+	.diseqc_send_master_cmd 	= firesat_diseqc_send_master_cmd,
+	.diseqc_send_burst		= firesat_diseqc_send_burst,
+	.set_tone			= firesat_set_tone,
+	.set_voltage			= firesat_set_voltage,
+};
+
+int firesat_frontend_attach(struct firesat *firesat, struct dvb_frontend *fe)
+{
+	switch (firesat->type) {
+	case FireSAT_DVB_S:
+		firesat->model_name = "FireSAT DVB-S";
+		firesat->frontend_info = &firesat_S_frontend_info;
+		break;
+	case FireSAT_DVB_C:
+		firesat->model_name = "FireSAT DVB-C";
+		firesat->frontend_info = &firesat_C_frontend_info;
+		break;
+	case FireSAT_DVB_T:
+		firesat->model_name = "FireSAT DVB-T";
+		firesat->frontend_info = &firesat_T_frontend_info;
+		break;
+	default:
+//		printk("%s: unknown model type 0x%x on subunit %d!\n",
+//			__func__, firesat->type,subunit);
+		printk("%s: unknown model type 0x%x !\n",
+			__func__, firesat->type);
+		firesat->model_name = "Unknown";
+		firesat->frontend_info = NULL;
+	}
+	fe->ops = firesat_ops;
+	fe->dvb = firesat->adapter;
+
+	return 0;
+}
+
+static struct dvb_frontend_info firesat_S_frontend_info = {
+
+	.name			= "FireSAT DVB-S Frontend",
+	.type			= FE_QPSK,
+
+	.frequency_min		= 950000,
+	.frequency_max		= 2150000,
+	.frequency_stepsize	= 125,
+	.symbol_rate_min	= 1000000,
+	.symbol_rate_max	= 40000000,
+
+	.caps 			= FE_CAN_INVERSION_AUTO		|
+				  FE_CAN_FEC_1_2		|
+				  FE_CAN_FEC_2_3		|
+				  FE_CAN_FEC_3_4		|
+				  FE_CAN_FEC_5_6		|
+				  FE_CAN_FEC_7_8		|
+				  FE_CAN_FEC_AUTO		|
+				  FE_CAN_QPSK,
+};
+
+static struct dvb_frontend_info firesat_C_frontend_info = {
+
+	.name			= "FireSAT DVB-C Frontend",
+	.type			= FE_QAM,
+
+	.frequency_min		= 47000000,
+	.frequency_max		= 866000000,
+	.frequency_stepsize	= 62500,
+	.symbol_rate_min	= 870000,
+	.symbol_rate_max	= 6900000,
+
+	.caps 			= FE_CAN_INVERSION_AUTO 	|
+				  FE_CAN_QAM_16			|
+				  FE_CAN_QAM_32			|
+				  FE_CAN_QAM_64			|
+				  FE_CAN_QAM_128		|
+				  FE_CAN_QAM_256		|
+				  FE_CAN_QAM_AUTO,
+};
+
+static struct dvb_frontend_info firesat_T_frontend_info = {
+
+	.name			= "FireSAT DVB-T Frontend",
+	.type			= FE_OFDM,
+
+	.frequency_min		= 49000000,
+	.frequency_max		= 861000000,
+	.frequency_stepsize	= 62500,
+
+	.caps 			= FE_CAN_INVERSION_AUTO		|
+				  FE_CAN_FEC_2_3		|
+				  FE_CAN_TRANSMISSION_MODE_AUTO |
+				  FE_CAN_GUARD_INTERVAL_AUTO	|
+				  FE_CAN_HIERARCHY_AUTO,
+};
